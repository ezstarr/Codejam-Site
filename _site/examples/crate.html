<!DOCTYPE HTML>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>crate</title>
  <link rel="shortcut icon" sizes="16x16 32x32 48x48 64x64 128x128 256x256" href="/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Try out Elm: A delightful language with friendly error messages, great performance, small assets, and no runtime exceptions.">
  <link rel="stylesheet" rel="preload" href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans|Courier+Prime&display=swap">
  <link rel="stylesheet" href="/assets/editor-styles.css"/>
</head>

<body>
<svg xmlns="http://www.w3.org/2000/svg" style="display:none;">
  <symbol id="logo" viewBox="-300 -300 600 600" fill="currentColor">
    <g transform="scale(1 -1)">
    <polygon points="-280,-90 0,190 280,-90" transform="translate(0 -210) rotate(0)"></polygon>
      <polygon points="-280,-90 0,190 280,-90" transform="translate(-210 0) rotate(-90)"></polygon>
      <polygon points="-198,-66 0,132 198,-66" transform="translate(207 207) rotate(-45)"></polygon>
      <polygon points="-130,0 0,-130 130,0 0,130" transform="translate(150 0) rotate(0)"></polygon>
      <polygon points="-191,61 69,61 191,-61 -69,-61" transform="translate(-89 239) rotate(0)"></polygon>
      <polygon points="-130,-44 0,86  130,-44" transform="translate(0 106) rotate(-180)"></polygon>
      <polygon points="-130,-44 0,86  130,-44" transform="translate(256 -150) rotate(-270)"></polygon>
    </g>
  </symbol>
</svg>

<main id="main"></main>
<textarea id="original" style="display:none;">-- Demonstrate how to load textures and put them on a cube.
--
-- Dependencies:
--   elm install elm-explorations/linear-algebra
--   elm install elm-explorations/webgl
--

import Browser
import Browser.Events as E
import Html exposing (Html)
import Html.Attributes exposing (width, height, style)
import Math.Matrix4 as Mat4 exposing (Mat4)
import Math.Vector2 as Vec2 exposing (Vec2, vec2)
import Math.Vector3 as Vec3 exposing (Vec3, vec3)
import Result
import Task
import WebGL
import WebGL.Texture as Texture



-- MAIN


main =
  Browser.element
    { init = init
    , view = view
    , update = \msg model -> (update msg model, Cmd.none)
    , subscriptions = subscriptions
    }



-- MODEL


type alias Model =
  { angle : Float
  , texture : Maybe Texture.Texture
  }


init : () -> (Model, Cmd Msg)
init () =
  ( { angle = 0
    , texture = Nothing
    }
  , Task.attempt GotTexture (Texture.load "https://elm-lang.org/images/wood-crate.jpg")
  )



-- UPDATE


type Msg
  = TimeDelta Float
  | GotTexture (Result Texture.Error Texture.Texture)


update : Msg -> Model -> Model
update msg model =
  case msg of
    TimeDelta dt ->
      { model | angle = model.angle + dt / 5000 }

    GotTexture result ->
      { model | texture = Result.toMaybe result }




-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
  E.onAnimationFrameDelta TimeDelta



-- VIEW


view : Model -> Html Msg
view model =
  case model.texture of
    Nothing ->
      Html.text "Loading texture..."

    Just texture ->
      WebGL.toHtml
        [ width 400, height 400, style "display" "block"
        ]
        [ WebGL.entity vertexShader fragmentShader crateMesh (toUniforms model.angle texture)
        ]



-- UNIFORMS


type alias Uniforms =
  { rotation : Mat4
  , perspective : Mat4
  , camera : Mat4
  , texture : Texture.Texture
  }


toUniforms : Float -> Texture.Texture -> Uniforms
toUniforms angle texture =
  { rotation =
      Mat4.mul
        (Mat4.makeRotate (3 * angle) (vec3 0 1 0))
        (Mat4.makeRotate (2 * angle) (vec3 1 0 0))
  , perspective = perspective
  , camera = camera
  , texture = texture
  }


perspective : Mat4
perspective =
  Mat4.makePerspective 45 1 0.01 100


camera : Mat4
camera =
  Mat4.makeLookAt (vec3 0 0 5) (vec3 0 0 0) (vec3 0 1 0)



-- MESH


type alias Vertex =
  { position : Vec3
  , coord : Vec2
  }


crateMesh : WebGL.Mesh Vertex
crateMesh =
  WebGL.triangles <| List.concatMap rotatedSquare <|
    [ (0, 0)
    , (90, 0)
    , (180, 0)
    , (270, 0)
    , (0, 90)
    , (0, 270)
    ]


rotatedSquare : (Float, Float) -> List (Vertex, Vertex, Vertex)
rotatedSquare (angleXZ, angleYZ) =
  let
    transformMat =
      Mat4.mul
        (Mat4.makeRotate (degrees angleXZ) Vec3.j)
        (Mat4.makeRotate (degrees angleYZ) Vec3.i)

    transform vertex =
      { vertex | position = Mat4.transform transformMat vertex.position }

    transformTriangle (a, b, c) =
      (transform a, transform b, transform c)
  in
  List.map transformTriangle square


square : List ( Vertex, Vertex, Vertex )
square =
  let
    topLeft     = Vertex (vec3 -1  1  1) (vec2 0 1)
    topRight    = Vertex (vec3  1  1  1) (vec2 1 1)
    bottomLeft  = Vertex (vec3 -1 -1  1) (vec2 0 0)
    bottomRight = Vertex (vec3  1 -1  1) (vec2 1 0)
  in
  [ (topLeft, topRight, bottomLeft)
  , (bottomLeft, topRight, bottomRight)
  ]



-- SHADERS


vertexShader : WebGL.Shader Vertex Uniforms { vcoord : Vec2 }
vertexShader =
  [glsl|
    attribute vec3 position;
    attribute vec2 coord;
    uniform mat4 perspective;
    uniform mat4 camera;
    uniform mat4 rotation;
    varying vec2 vcoord;

    void main () {
        gl_Position = perspective * camera * rotation * vec4(position, 1.0);
        vcoord = coord;
    }
  |]


fragmentShader : WebGL.Shader {} Uniforms { vcoord : Vec2 }
fragmentShader =
  [glsl|
    precision mediump float;
    uniform sampler2D texture;
    varying vec2 vcoord;

    void main () {
        gl_FragColor = texture2D(texture, vcoord);
    }
  |]</textarea>
<script src="/assets/editor-codemirror.js"></script>
<script src="/assets/editor-custom-elements.js"></script>
<script src="/assets/editor-elm.js"></script>
<script>
  window.addEventListener('load', function() {
    var originalCode = document.getElementById('original').textContent;
    main = Elm.Page.Editor.init({
      node: document.getElementById('main'),
      flags: {
        name: "crate",
        width: window.innerWidth,
        height: window.innerHeight,
        original: document.getElementById('original').textContent,
        dependencies: { "direct": {
    "elm/browser": "1.0.2",
    "elm/core": "1.0.5",
    "elm/html": "1.0.0",
    "elm-explorations/linear-algebra": "1.0.3",
    "elm-explorations/webgl": "1.1.3"
  },
  "indirect": {
    "elm/json": "1.1.3",
    "elm/time": "1.0.0",
    "elm/url": "1.0.0",
    "elm/virtual-dom": "1.0.2"
  }
}
      }
    });

    main.ports.submitSource.subscribe(function(source) {
      var editorNode = document.getElementById('editor');
      var codeNode = document.getElementById('code');
      codeNode.value = source;
      editorNode.submit();
    });

    window.addEventListener("message", gotErrors, false);

    function gotErrors(event) {
      if (event.origin !== "https://elm.studio" && event.origin !== "https://social.elm.studio") return;
      if (event.data == "SUCCESS") {
        main.ports.gotSuccess.send(null);
      } else {
        var message = JSON.parse(event.data);
        main.ports.gotErrors.send(message);
      }
    }

    window.addEventListener("error", function (e) {
      main.ports.gotJsError.send(e.error.message);
      return false;
    });

  });
</script>

</body>

</html>

