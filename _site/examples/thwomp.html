<!DOCTYPE HTML>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>thwomp</title>
  <link rel="shortcut icon" sizes="16x16 32x32 48x48 64x64 128x128 256x256" href="/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Try out Elm: A delightful language with friendly error messages, great performance, small assets, and no runtime exceptions.">
  <link rel="stylesheet" rel="preload" href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans|Courier+Prime&display=swap">
  <link rel="stylesheet" href="/assets/editor-styles.css"/>
</head>

<body>
<svg xmlns="http://www.w3.org/2000/svg" style="display:none;">
  <symbol id="logo" viewBox="-300 -300 600 600" fill="currentColor">
    <g transform="scale(1 -1)">
    <polygon points="-280,-90 0,190 280,-90" transform="translate(0 -210) rotate(0)"></polygon>
      <polygon points="-280,-90 0,190 280,-90" transform="translate(-210 0) rotate(-90)"></polygon>
      <polygon points="-198,-66 0,132 198,-66" transform="translate(207 207) rotate(-45)"></polygon>
      <polygon points="-130,0 0,-130 130,0 0,130" transform="translate(150 0) rotate(0)"></polygon>
      <polygon points="-191,61 69,61 191,-61 -69,-61" transform="translate(-89 239) rotate(0)"></polygon>
      <polygon points="-130,-44 0,86  130,-44" transform="translate(0 106) rotate(-180)"></polygon>
      <polygon points="-130,-44 0,86  130,-44" transform="translate(256 -150) rotate(-270)"></polygon>
    </g>
  </symbol>
</svg>

<main id="main"></main>
<textarea id="original" style="display:none;">-- Thwomp looks at your mouse. What is it up to?
--
-- Dependencies:
--   elm install elm/json
--   elm install elm-explorations/linear-algebra
--   elm install elm-explorations/webgl
--
-- Thanks to The PaperNES Guy for the texture:
--   https://the-papernes-guy.deviantart.com/art/Thwomps-Thwomps-Thwomps-186879685


import Browser
import Browser.Dom as Dom
import Browser.Events as E
import Html exposing (Html)
import Html.Attributes exposing (height, style, width)
import Json.Decode as D
import Math.Matrix4 as Mat4 exposing (Mat4)
import Math.Vector2 as Vec2 exposing (Vec2, vec2)
import Math.Vector3 as Vec3 exposing (Vec3, vec3)
import Result
import Task
import WebGL
import WebGL.Texture as Texture



-- MAIN


main : Program () Model Msg
main =
  Browser.element
    { init = init
    , view = view
    , update = \msg model -> ( update msg model, Cmd.none )
    , subscriptions = subscriptions
    }



-- MODEL


type alias Model =
  { width : Float
  , height : Float
  , x : Float
  , y : Float
  , side : Maybe Texture.Texture
  , face : Maybe Texture.Texture
  }


init : () -> ( Model, Cmd Msg )
init _ =
  ( { width = 0
    , height = 0
    , x = 0
    , y = 0
    , face = Nothing
    , side = Nothing
    }
  , Cmd.batch
      [ Task.perform GotViewport Dom.getViewport
      , Task.attempt GotFace (Texture.loadWith options "https://elm-lang.org/images/thwomp-face.jpg")
      , Task.attempt GotSide (Texture.loadWith options "https://elm-lang.org/images/thwomp-side.jpg")
      ]
  )


options : Texture.Options
options =
  { magnify = Texture.nearest
  , minify = Texture.nearest
  , horizontalWrap = Texture.repeat
  , verticalWrap = Texture.repeat
  , flipY = True
  }



-- UPDATE


type Msg
  = GotFace (Result Texture.Error Texture.Texture)
  | GotSide (Result Texture.Error Texture.Texture)
  | GotViewport Dom.Viewport
  | Resized Int Int
  | MouseMoved Float Float


update : Msg -> Model -> Model
update msg model =
  case msg of
    GotFace result ->
      { model
          | face = Result.toMaybe result
      }

    GotSide result ->
      { model
          | side = Result.toMaybe result
      }

    GotViewport { viewport } ->
      { model
          | width = viewport.width
          , height = viewport.height
      }

    Resized width height ->
      { model
          | width = toFloat width
          , height = toFloat height
      }

    MouseMoved x y ->
      { model
          | x = x
          , y = y
      }



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
  Sub.batch
    [ E.onResize Resized
    , E.onMouseMove decodeMovement
    ]


decodeMovement : D.Decoder Msg
decodeMovement =
  D.map2 MouseMoved
    (D.field "pageX" D.float)
    (D.field "pageY" D.float)



-- VIEW


view : Model -> Html Msg
view model =
  case Maybe.map2 Tuple.pair model.face model.side of
    Nothing ->
      Html.text "Loading textures..."

    Just (face, side) ->
      let
        perspective =
          toPerspective model.x model.y model.width model.height
      in
      WebGL.toHtml
        [ style "display" "block"
        , style "position" "absolute"
        , style "left" "0"
        , style "top" "0"
        , width (round model.width)
        , height (round model.height)
        ]
        [ WebGL.entity vertexShader fragmentShader faceMesh
            { perspective = perspective
            , texture = face
            }
        , WebGL.entity vertexShader fragmentShader sidesMesh
            { perspective = perspective
            , texture = side
            }
        ]


toPerspective : Float -> Float -> Float -> Float -> Mat4
toPerspective x y width height =
  let
    eye =
      Vec3.scale 6 <| Vec3.normalize <|
        vec3 (0.5 - x / width) (y / height - 0.5) 1
  in
  Mat4.mul
    (Mat4.makePerspective 45 (width / height) 0.01 100)
    (Mat4.makeLookAt eye (vec3 0 0 0) Vec3.j)



-- MESHES


type alias Vertex =
  { position : Vec3
  , coord : Vec2
  }


faceMesh : WebGL.Mesh Vertex
faceMesh =
  WebGL.triangles square


sidesMesh : WebGL.Mesh Vertex
sidesMesh =
  WebGL.triangles <| List.concatMap rotatedSquare <|
    [ (90, 0)
    , (180, 0)
    , (270, 0)
    , (0, 90)
    , (0, 270)
    ]


rotatedSquare : (Float, Float) -> List (Vertex, Vertex, Vertex)
rotatedSquare (angleXZ, angleYZ) =
  let
    transformMat =
      Mat4.mul
        (Mat4.makeRotate (degrees angleXZ) Vec3.j)
        (Mat4.makeRotate (degrees angleYZ) Vec3.i)

    transform vertex =
      { vertex | position = Mat4.transform transformMat vertex.position }

    transformTriangle (a, b, c) =
      (transform a, transform b, transform c)
  in
  List.map transformTriangle square


square : List ( Vertex, Vertex, Vertex )
square =
  let
    topLeft     = Vertex (vec3 -1  1  1) (vec2 0 1)
    topRight    = Vertex (vec3  1  1  1) (vec2 1 1)
    bottomLeft  = Vertex (vec3 -1 -1  1) (vec2 0 0)
    bottomRight = Vertex (vec3  1 -1  1) (vec2 1 0)
  in
  [ (topLeft, topRight, bottomLeft)
  , (bottomLeft, topRight, bottomRight)
  ]



-- SHADERS


type alias Uniforms =
  { perspective : Mat4
  , texture : Texture.Texture
  }


vertexShader : WebGL.Shader Vertex Uniforms { vcoord : Vec2 }
vertexShader =
  [glsl|
    attribute vec3 position;
    attribute vec2 coord;
    uniform mat4 perspective;
    varying vec2 vcoord;

    void main () {
      gl_Position = perspective * vec4(position, 1.0);
      vcoord = coord.xy;
    }
  |]


fragmentShader : WebGL.Shader {} Uniforms { vcoord : Vec2 }
fragmentShader =
  [glsl|
    precision mediump float;
    uniform sampler2D texture;
    varying vec2 vcoord;

    void main () {
      gl_FragColor = texture2D(texture, vcoord);
    }
  |]</textarea>
<script src="/assets/editor-codemirror.js"></script>
<script src="/assets/editor-custom-elements.js"></script>
<script src="/assets/editor-elm.js"></script>
<script>
  window.addEventListener('load', function() {
    var originalCode = document.getElementById('original').textContent;
    main = Elm.Page.Editor.init({
      node: document.getElementById('main'),
      flags: {
        name: "thwomp",
        width: window.innerWidth,
        height: window.innerHeight,
        original: document.getElementById('original').textContent,
        dependencies: { "direct": {
    "elm/browser": "1.0.2",
    "elm/core": "1.0.5",
    "elm/html": "1.0.0",
    "elm/json": "1.1.3",
    "elm-explorations/linear-algebra": "1.0.3",
    "elm-explorations/webgl": "1.1.3"
  },
  "indirect": {
    "elm/time": "1.0.0",
    "elm/url": "1.0.0",
    "elm/virtual-dom": "1.0.2"
  }
}
      }
    });

    main.ports.submitSource.subscribe(function(source) {
      var editorNode = document.getElementById('editor');
      var codeNode = document.getElementById('code');
      codeNode.value = source;
      editorNode.submit();
    });

    window.addEventListener("message", gotErrors, false);

    function gotErrors(event) {
      if (event.origin !== "https://elm.studio" && event.origin !== "https://social.elm.studio") return;
      if (event.data == "SUCCESS") {
        main.ports.gotSuccess.send(null);
      } else {
        var message = JSON.parse(event.data);
        main.ports.gotErrors.send(message);
      }
    }

    window.addEventListener("error", function (e) {
      main.ports.gotJsError.send(e.error.message);
      return false;
    });

  });
</script>

</body>

</html>

